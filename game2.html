<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>เกมจิ๊กซอว์ - จิ้มวาง</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Prompt', sans-serif;
      background: #fce4ec;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    #startScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #f8bbd0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    #startBtn {
      font-size: 24px;
      padding: 12px 30px;
      background: #ec407a;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transition: background-color 0.3s ease;
    }
    #startBtn:hover {
      background: #d81b60;
    }
    #gameWrapper {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 10px 0 40px;
      width: 100%;
      max-width: 380px;
    }
    #thumbnails {
      margin-bottom: 10px;
    }
    .thumbnail {
      width: 60px;
      margin: 0 5px;
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 8px;
      transition: border-color 0.3s;
      opacity: 1;
      pointer-events: auto;
    }
    .thumbnail.selected {
      border-color: #ec407a;
    }
    .thumbnail.locked {
      opacity: 0.4;
      pointer-events: none;
    }
    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #pieceContainer, #puzzleBoard {
      display: grid;
      grid-template-columns: repeat(4, 80px);
      grid-template-rows: repeat(4, 80px);
      gap: 5px;
      margin: 10px 0;
    }
    .piece, .dropzone {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      user-select: none;
    }
    .piece {
      background-size: 320px 320px;
      border: 2px solid #fff;
      cursor: pointer;
      transition: outline 0.2s, box-shadow 0.3s;
    }
    .piece.selected {
      outline: 3px solid #2196f3;
      box-shadow: 0 0 10px 3px #2196f3;
    }
    .piece.locked {
      cursor: default;
      box-shadow: 0 0 10px 3px #4caf50 !important;
      border-color: #4caf50 !important;
    }
    .dropzone {
      background: #fce4ec;
      border: 2px dashed #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .dropzone.correct {
      background-color: #c8e6c9;
      border-color: #4caf50;
    }
    .dropzone.incorrect {
      background-color: #ffcdd2;
      border-color: #f44336;
    }
    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-direction: column;
      z-index: 99;
      text-align: center;
      padding: 20px;
    }
    #popup button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: #ec407a;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transition: background-color 0.3s;
    }
    #popup button:hover {
      background: #d81b60;
    }
    .back-link {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 24px;
      background-color: #ec407a;
      color: white;
      font-weight: bold;
      border-radius: 12px;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transition: background-color 0.3s, transform 0.3s;
      user-select: none;
    }
    .back-link:hover {
      background-color: #d81b60;
      transform: scale(1.05);
    }
  </style>
</head>
<body>

  <div id="startScreen">
    <button id="startBtn">เริ่มเกม</button>
  </div>

  <div id="gameWrapper">
    <div id="thumbnails">
      <img src="jigsaw1.jpg" class="thumbnail" alt="รูปภาพ 1" onclick="startGame(this, 'jigsaw1.jpg')" />
      <img src="jigsaw2.jpg" class="thumbnail" alt="รูปภาพ 2" onclick="startGame(this, 'jigsaw2.jpg')" />
      <img src="jigsaw3.jpg" class="thumbnail" alt="รูปภาพ 3" onclick="startGame(this, 'jigsaw3.jpg')" />
    </div>

    <div id="gameContainer">
      <div id="pieceContainer"></div>
      <div id="puzzleBoard"></div>
    </div>

    <a href="game-menu.html" class="back-link">ย้อนกลับ</a>
  </div>

  <div id="popup">
    เกมส์นี้ก็ชนะอีกแล้ว<br>ชนะทุกอย่างเลย เก่งมาก
    <button onclick="resetGame()">เล่นอีกครั้ง</button>
  </div>

  <audio id="bgm" loop></audio>

  <script>
    const startBtn = document.getElementById('startBtn');
    const startScreen = document.getElementById('startScreen');
    const gameWrapper = document.getElementById('gameWrapper');
    const bgm = document.getElementById('bgm');

    const rows = 4;
    const cols = 4;
    const totalPieces = rows * cols;
    const pieceWidth = 80;
    const pieceHeight = 80;
    const puzzleBoard = document.getElementById('puzzleBoard');
    const pieceContainer = document.getElementById('pieceContainer');
    const popup = document.getElementById('popup');
    const thumbnails = document.querySelectorAll('.thumbnail');

    let selectedPiece = null;
    let correctCount = 0;
    let completedPositions = new Array(totalPieces).fill(false);
    let currentImage = null;

    // เก็บสถานะภาพที่ผ่านแล้ว
    let completedImages = new Set();

    startBtn.addEventListener('click', () => {
      startScreen.style.display = 'none';
      gameWrapper.style.display = 'flex';
      bgm.src = "https://media.vocaroo.com/mp3/1bFaEBX6V9fH";
      bgm.play();
    });

    function startGame(el, imagePath) {
      if (completedImages.has(imagePath)) {
        alert("คุณเล่นภาพนี้ครบแล้ว กรุณาเลือกภาพอื่น");
        return;
      }
      currentImage = imagePath;
      correctCount = 0;
      completedPositions.fill(false);
      selectedPiece = null;

      thumbnails.forEach(img => {
        img.classList.remove('selected');
        if (completedImages.has(img.getAttribute('src'))) {
          img.classList.add('locked');
        } else {
          img.classList.remove('locked');
        }
      });
      el.classList.add('selected');

      pieceContainer.innerHTML = '';
      puzzleBoard.innerHTML = '';

      // สร้าง dropzones
      for (let i = 0; i < totalPieces; i++) {
        const dropzone = document.createElement('div');
        dropzone.classList.add('dropzone');
        dropzone.dataset.index = i;
        dropzone.addEventListener('click', () => onDropzoneClick(dropzone));
        puzzleBoard.appendChild(dropzone);
      }

      // สร้างชิ้นส่วนและสุ่มตำแหน่งใน pieceContainer
      const positions = [...Array(totalPieces).keys()];
      shuffleArray(positions);

      positions.forEach(i => {
        const piece = createPiece(imagePath, i);
        piece.dataset.index = i;
        piece.addEventListener('click', () => onPieceClick(piece));
        pieceContainer.appendChild(piece);
      });

      popup.style.display = 'none';
    }

    function createPiece(imagePath, index) {
      const piece = document.createElement('div');
      piece.classList.add('piece');
      piece.style.backgroundImage = `url('${imagePath}')`;
      piece.style.backgroundPosition = `-${(index % cols) * pieceWidth}px -${Math.floor(index / cols) * pieceHeight}px`;
      return piece;
    }

    function onPieceClick(piece) {
      if (piece.classList.contains('locked')) return;
      if (selectedPiece) {
        selectedPiece.classList.remove('selected');
      }
      selectedPiece = piece;
      selectedPiece.classList.add('selected');
    }

    function onDropzoneClick(dropzone) {
      if (!selectedPiece) return;

      // ถ้ามีชิ้นอยู่ใน dropzone ให้ย้ายกลับมา pieceContainer
      if (dropzone.firstChild) {
        const oldPiece = dropzone.firstChild;
        oldPiece.classList.remove('selected');
        if (!oldPiece.classList.contains('locked')) pieceContainer.appendChild(oldPiece);

        // อัปเดตสถานะชิ้นที่ถูกย้ายออก
        const oldIndex = parseInt(oldPiece.dataset.index);
        completedPositions[oldIndex] = false;
        correctCount--;
      }

      // วาง selectedPiece ลง dropzone
      dropzone.appendChild(selectedPiece);
      selectedPiece.classList.remove('selected');

      const pieceIndex = parseInt(selectedPiece.dataset.index);
      const dropIndex = parseInt(dropzone.dataset.index);

      if (pieceIndex === dropIndex) {
        dropzone.classList.add('correct');
        dropzone.classList.remove('incorrect');
        selectedPiece.classList.add('locked');
        selectedPiece.style.boxShadow = '0 0 10px 3px #4caf50';
        completedPositions[pieceIndex] = true;
        correctCount++;
      } else {
        dropzone.classList.add('incorrect');
        dropzone.classList.remove('correct');
        selectedPiece.style.boxShadow = '0 0 10px 3px #f44336';
        completedPositions[pieceIndex] = false;

        // ชิ้นผิดไม่ล็อก ให้ย้ายกลับมา pieceContainer ทันที
        setTimeout(() => {
          if (dropzone.firstChild === selectedPiece) {
            dropzone.removeChild(selectedPiece);
            selectedPiece.style.boxShadow = '';
            pieceContainer.appendChild(selectedPiece);
          }
        }, 500);
      }

      selectedPiece = null;

      checkImageComplete();
    }

    function checkImageComplete() {
      if (correctCount === totalPieces) {
        completedImages.add(currentImage);

        // ล็อก thumbnails
        thumbnails.forEach(img => {
          if (img.getAttribute('src') === currentImage) {
            img.classList.add('locked');
            img.classList.remove('selected');
          }
        });

        // เคลียร์ชิ้นส่วนที่เหลือ
        pieceContainer.innerHTML = '';

        if (completedImages.size === 3) {
          setTimeout(() => {
            popup.style.display = 'flex';
            bgm.pause();
            bgm.currentTime = 0;
          }, 400);
        } else {
          alert('ภาพนี้ต่อครบแล้ว! เลือกภาพใหม่เล่นต่อได้เลย');
        }
      }
    }

    function shuffleArray(array) {
      for (let i = array.length -1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i +1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function resetGame() {
      popup.style.display = 'none';
      pieceContainer.innerHTML = '';
      puzzleBoard.innerHTML = '';
      currentImage = null;
      correctCount = 0;
      completedPositions.fill(false);
      completedImages.clear();
      selectedPiece = null;
      thumbnails.forEach(img => {
        img.classList.remove('locked');
        img.classList.remove('selected');
      });
      startScreen.style.display = 'flex';
      gameWrapper.style.display = 'none';
      bgm.pause();
      bgm.currentTime = 0;
    }
  </script>

</body>
</html>
